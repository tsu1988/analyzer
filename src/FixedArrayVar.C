//*-- Author :    Ole Hansen   15/2/2016

//////////////////////////////////////////////////////////////////////////
//
// FixedArrayVar
//
// A "global variable" referencing a fixed size array of basic data.
//
//////////////////////////////////////////////////////////////////////////

#include "FixedArrayVar.h"
#include "THaVar.h"
#include "TError.h"
#include <iostream>
#include <cstring>
#include <typeinfo>

using namespace std;

namespace Podd {

//_____________________________________________________________________________
FixedArrayVar::FixedArrayVar( THaVar* pvar, const void* addr, VarType type )
  : Variable(pvar,addr,type), fParsedName(GetName())
{
  // Constructor

  if( !CheckName(fParsedName) ) {
    fValueP = 0;
    return;
  }

  fVar->SetName( fParsedName.GetName() );
}

//_____________________________________________________________________________
Bool_t FixedArrayVar::CheckName( const THaArrayString& parsed_name ) const
{
  // Return true if name seems to be OK

  const char* const here = "FixedArrayVar::CheckName";

  bool good = true;

  if( parsed_name.IsError() ) {
    fVar->Error( here, "Malformed array syntax for variable %s", GetName() );
    good = false;
  } else if( !parsed_name.IsArray() ) {
    fVar->Error( here, "Specification \"%s\" for variable %s is not a "
		 "fixed array", parsed_name.GetName(), GetName() );
    good = false;
  }
    
  return good;
}

//_____________________________________________________________________________
Int_t FixedArrayVar::GetLen() const
{
  // Get number of elements of the variable

  return fParsedName.GetLen();
}

//_____________________________________________________________________________
const Int_t* FixedArrayVar::GetDim() const
{
  // Return array of dimensions of the array. Scalers are always return a
  // pointer to 1 (as with array definition [1]).

  return fParsedName.GetDim();
}

//_____________________________________________________________________________
Bool_t FixedArrayVar::HasSameSize( const Variable& rhs ) const
{
  // Compare the size (=number of elements) of this variable to that of 'rhs'.

  if( typeid(*this) != typeid(rhs) )
    return kFALSE;

  assert( dynamic_cast<const FixedArrayVar*>(&rhs) );
  const FixedArrayVar* other = static_cast<const FixedArrayVar*>(&rhs);

  return ( fParsedName.GetNdim() == other->fParsedName.GetNdim() &&
	   fParsedName.GetLen()  == other->fParsedName.GetLen() );
}

//_____________________________________________________________________________
Bool_t FixedArrayVar::IsArray() const
{
  // Data are an array (GetLen() may be != 1)

  return kTRUE;
}

//_____________________________________________________________________________
Bool_t FixedArrayVar::IsContiguous() const
{
  // Data are contiguous in memory

  return !IsPointerArray();
}

//_____________________________________________________________________________
Bool_t FixedArrayVar::IsPointerArray() const
{
  // Data are an array of pointers to data

  return fType>=kDouble2P && fType <= kObject2P;
}

//_____________________________________________________________________________
Bool_t FixedArrayVar::IsVarArray() const
{
  // Variable is a variable-sized array

  return kFALSE;
}

//_____________________________________________________________________________
void FixedArrayVar::Print(Option_t* option) const
{
  // Print a description of this variable. If option=="FULL" (default), also
  // print current data

  fVar->TNamed::Print(option);

  if( strcmp(option, "FULL") ) return;

  cout << "(" << GetTypeName() << ")=[";
  fParsedName.Print("dimonly");
  cout << "]";
  for( int i=0; i<GetLen(); i++ ) {
    cout << "  ";
    if( IsFloat() )
      cout << GetValue(i);
    else
      cout << GetValueInt(i);
  }
  cout << endl;
}

//_____________________________________________________________________________
void FixedArrayVar::SetName( const char* name )
{
  // Set the name of the variable

  THaArrayString new_name = name;
  if( !CheckName(new_name) )
    return;

  fVar->SetName( new_name );
  fParsedName = new_name;
}

//_____________________________________________________________________________
void FixedArrayVar::SetNameTitle( const char* name, const char* descript )
{
  // Set name and description of the variable

  THaArrayString new_name = name;
  if( !CheckName(new_name) )
    return;

  fVar->SetNameTitle( new_name, descript );
  fParsedName = new_name;
}

//_____________________________________________________________________________

} //namespace Podd

ClassImp(Podd::FixedArrayVar)
